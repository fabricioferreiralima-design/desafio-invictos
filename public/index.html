<!DOCTYPE html>
<html lang="pt-br">
<head>

  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>InÃ­cio</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  
</head>


<body>
<script src="authGuard.js"></script>

<div class="topo-palpitar">
<header>
  <div class="nav-bar">

    <div class="nav-left"></div>

    <ul class="nav-center">
      <li><a href="index.html" id="linkInicio">InÃ­cio</a></li>
      <li><a href="palpitar.html" id="linkPalpitar">Palpitar!</a></li>
      <li><a href="simulador.html" id="linkSimulador">Simulador</a></li>
    </ul>

    <div class="user-menu">
      <button class="menu-btn" id="btnMenuUser">â˜°</button>

      <div class="menu-dropdown hidden" id="menuDropdown">
        <button id="btnLogout">ğŸšª Sair</button>
      </div>
    </div>

  </div>
</header>

<!-- âœ… SELETOR DE DESAFIO (ESTAVA FALTANDO) -->
  <div id="seletorDesafioContainer" style="display:none;">
    <div>
      <strong>ğŸ¯ Desafio:</strong>
      <select id="selectDesafioGlobal"></select>
    </div>
  </div>

<script src="/js/seletorDesafio.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", initSeletorDesafio);
</script>

</div>

<script src="/js/alertaVerificacao.js"></script>

<div class="container index-hero">
  <h1>ğŸ† Bem-vindo ao Desafio Invictos</h1>

  <p class="hero-subtitle">
    VocÃª estÃ¡ participando de um jogo de sobrevivÃªncia.
    <strong>Um palpite errado e vocÃª estÃ¡ fora!</strong>
  </p>

  <!-- FAIXA COMO JOGAR -->
  <div class="como-jogar-cta" id="btnComoJogar">
    <span>ğŸ® Como jogar?</span>
    <small>Clique aqui e entenda o desafio</small>
  </div>
</div>


<div id="statusJogador" style="
  max-width: 800px;
  margin: 20px auto;
  padding: 15px;
  border-radius: 8px;
  text-align: center;
  font-size: 18px;
  display: none;
"></div>


<section class="index-dashboard">
  <div class="index-dashboard-inner">

    <!-- COLUNA ESQUERDA -->
    <div class="index-card">
      <h3>ğŸ“… Sua trajetÃ³ria no desafio</h3>

      <div class="timeline">
        <div class="timeline-line"></div>
        <div id="timelineContainer">
          <p class="vazio">Carregando palpites...</p>
        </div>
      </div>
    </div>

    <!-- COLUNA DIREITA -->
    <div class="index-cards">

      <div class="index-card index-card-desafio">
        <h3>ğŸ“Š O Desafio</h3>

        <div class="stat">
          <span>ğŸ‘¥ Jogadores que comeÃ§aram</span>
          <strong id="statIniciaram">â€”</strong>
        </div>

       <div class="stat">
  <span>ğŸŸ¢ Ainda vivos</span>

  <div style="display:flex; align-items:baseline; gap:8px;">
    <strong class="alive" id="statVivos">â€”</strong>

    <small id="statPendentesBox"
     title="Jogadores ativos com jogo ainda nÃ£o finalizado"
      style="
        display:none;
        color:#b45309;
        background:#fffbeb;
        border:1px solid #fde68a;
        padding:2px 6px;
        border-radius:6px;
        font-size:12px;
      ">
      â³ <span id="statPendentes">â€”</span> ainda com palpite pendente - jogo adiado
    </small>
  </div>
</div>

        <div class="stat">
          <span>ğŸ”´ Eliminados</span>
          <strong class="dead" id="statEliminados">â€”</strong>
        </div>

        <div class="destaque">
          âš”ï¸  <strong id="statPercentual"></strong><strong>%</strong> dos jogadores continuam vivos!
        </div>
      </div>

      <div class="index-card index-card-rodada">
  <h3>ğŸ”¥ Ãšltima Rodada</h3>

  <div class="destaque leve" id="statRodadaTitulo">
    Rodada â€” â€”
  </div>

  <div class="stat texto">
    ğŸ’¥ <strong id="statEliminadosRodada">â€”</strong> jogadores foram eliminados nesta rodada
  </div>

  <div class="stat coluna">
    <strong>ğŸ“Š Times mais escolhidos</strong>
    <ul id="statTopTimes"></ul>
  </div>

  <div class="destaque mortal">
    â˜ ï¸ <strong>Time mais mortal:</strong>
    <span id="statTimeMortal">â€”</span>
  </div>
</div>

    </div>
  </div>
</section>
<script>

let rodadaAtualGlobal = null;
let statusDesafioIndex = null;
let rodadaAtualIndex = null;

function podeEntrarNoDesafio(usuario, desafio) {

  // jÃ¡ Ã© participante
  if (usuario.status === "ativo")
    return true;

  // ainda nÃ£o entrou, mas desafio estÃ¡ iniciando
  if (
    usuario.status === "nao_inscrito" &&
    desafio.status === "iniciando"
  )
    return true;

  return false;
}

function bloqueioDefinitivo(usuario, desafio) {

  return (
    usuario.status === "nao_inscrito" &&
    desafio.status !== "iniciando"
  );
}


async function carregarContextoDoJogoCompleto() {
  const token = localStorage.getItem("authToken");

  if (!token) return null;

  const res = await fetch("/api/jogo/contexto", {
    headers: getAuthHeaders()
  });

  if (!res.ok) {
    throw new Error("Erro ao carregar contexto do jogo");
  }

  return await res.json(); // ğŸ‘‰ retorna { desafio, usuario }
}


  // Destacar o link ativo no menu
  const paginaAtual = window.location.pathname.split("/").pop();
  if (paginaAtual.includes("index")) document.getElementById("linkInicio").classList.add("ativo");
  else if (paginaAtual.includes("palpitar")) document.getElementById("linkPalpitar").classList.add("ativo");
  else if (paginaAtual.includes("simulador")) document.getElementById("linkSimulador").classList.add("ativo");

  // Carregar histÃ³rico de palpites
  async function carregarLinhaDoTempo() {
  const container = document.getElementById("timelineContainer");
  container.innerHTML = "<p class='vazio'>Carregando palpites...</p>";

  try {
    const token = localStorage.getItem("authToken");

    const res = await fetch("/api/linha-do-tempo", {
    headers: getAuthHeaders()});

    if (!res.ok) {
      container.innerHTML = "<p class='vazio'>Erro ao carregar linha do tempo.</p>";
      return;
    }

    const dados = await res.json();

    if (!dados.length) {
      container.innerHTML = "<p class='vazio'>Nenhum palpite encontrado.</p>";
      return;
    }

container.innerHTML = dados.map(item => {

// ğŸ”’ bloqueia APENAS a rodada atual quando estÃ¡ aguardando
const aguardando =
  statusDesafioIndex === "aguardando" &&
  rodadaAtualGlobal !== null &&
  item.rodada === rodadaAtualGlobal;

  let classe = "neutro";
  let statusTexto = "â“ Aguardando resultado";
  let placarTexto = "â³ Aguardando jogo...";

  // sÃ³ mostra resultado quando NÃƒO estÃ¡ aguardando
  if (!aguardando) {
    placarTexto = item.placar;

    if (item.status === "sobreviveu") {
      classe = "sobreviveu";
      statusTexto = "âœ… Sobreviveu";
    }

    if (item.status === "eliminado") {
      classe = "eliminado";
      statusTexto = "âŒ Eliminado";
    }
  }

  // destaque visual da rodada atual (sem spoiler)
  if (rodadaAtualGlobal && item.rodada === rodadaAtualGlobal) {
    classe += " atual";
  }

  return `
    <div class="timeline-row ${classe}">
      <div class="timeline-dot"></div>

      <div class="timeline-item">
        <div class="rodada">Rodada ${item.rodada}</div>
        <div class="escolha">Time escolhido: <strong>${item.time}</strong></div>
        <div class="placar">${placarTexto}</div>
        <div class="status">${statusTexto}</div>
      </div>
    </div>
  `;
}).join("");


  } catch (err) {
    console.error(err);
    container.innerHTML = "<p class='vazio'>Erro ao carregar dados.</p>";
  }

  
}


async function carregarContextoIndex() {
  const token = localStorage.getItem("authToken");

  if (!token) {
    mostrarMensagem("ğŸ” FaÃ§a login para participar do desafio.");
    return;
  }

  try {
    const res = await fetch("/api/jogo/contexto", {
    headers: getAuthHeaders()
    });

    if (!res.ok) {
      mostrarMensagem("âš ï¸ Nenhum desafio ativo no momento.");
      return;
    }

    const data = await res.json();

    interpretarContextoIndex(data);

  } catch (err) {
    console.error(err);
    mostrarMensagem("âŒ Erro ao carregar informaÃ§Ãµes do jogo.");
  }
}

function interpretarContextoIndex(contexto) {
   const { desafio, usuario } = contexto;
   
statusDesafioIndex = desafio.status;
rodadaAtualIndex = desafio.rodadaAtual;


  rodadaAtualGlobal = desafio.rodadaAtual;

  // =====================================================
  // ğŸ›‘ BLOQUEIO DEFINITIVO â€” perdeu janela da 1Âª rodada
  // =====================================================
  if (bloqueioDefinitivo(usuario, desafio)) {

    mostrarMensagem(
      "â›” VocÃª nÃ£o entrou no desafio a tempo. " +
      "Aguarde o prÃ³ximo desafio para participar."
    );

    document.querySelector(".index-dashboard").style.display = "none";

    return;
  }

  // =====================================================
  // ğŸŸ¢ PODE ENTRAR (mensagem atual mantida!)
  // =====================================================
 if (
  usuario.status === "nao_inscrito" &&
  desafio.status === "iniciando"
) {

  mostrarMensagem(
    "ğŸ”¥ Chega mais! O desafio jÃ¡ vai comeÃ§ar. Ã‰ hora de palpitar."
  );

  // âœ… GARANTE QUE O DASHBOARD FIQUE VISÃVEL
  const dash = document.querySelector(".index-dashboard");
  if (dash) dash.style.display = "";

  return;
}


  // ğŸŸ¥ DESAFIO FINALIZADO
  if (desafio.status === "finalizado") {
    if (usuario.status === "eliminado") {
      mostrarMensagem(
        `ğŸ Aqui acabou chefe! VocÃª foi eliminado na rodada ${usuario.rodadaEliminacao}.`
      );
    } else {
      mostrarMensagem(
        "ğŸ† Mandou bem demais! VocÃª foi o campeÃ£o dessa ediÃ§Ã£o. Passa o pix!"
      );
    }
    return;
  }

  // âŒ USUÃRIO ELIMINADO (independente do status)
  if (usuario.status === "eliminado") {
    mostrarMensagem(
      `âŒ Deu ruim! VocÃª foi eliminado na rodada ${usuario.rodadaEliminacao}.`
    );

    return;
    
  }

  // ğŸŸ¡ DESAFIO AGUARDANDO (rodada em andamento)
  if (desafio.status === "aguardando") {
    mostrarMensagem(
      "â³ A rodada estÃ¡ em andamento. Espero que sua escolha nÃ£o te decepcione."
    );
    return;
  }

  // ğŸŸ¢ DESAFIO INICIANDO ou ATIVO
// ğŸŸ¢ DESAFIO INICIANDO ou ATIVO
if (desafio.status === "iniciando" || desafio.status === "ativo") {

  // =====================================================
  // ğŸ‘‰ CASO ESPECIAL: usuÃ¡rio ainda NÃƒO inscrito
  // =====================================================
  if (usuario.status === "nao_inscrito") {

    mostrarMensagem(
      "ğŸ”¥ Chega mais! O desafio jÃ¡ vai comeÃ§ar. Ã‰ hora de palpitar."
    );

    // âš ï¸ NÃƒO damos return aqui para:
    // - permitir timeline
    // - permitir estatÃ­sticas

  } else {

    // =====================================================
    // FLUXO NORMAL DE PARTICIPANTE
    // =====================================================

    if (usuario.jaPalpitou) {
      mostrarMensagem(
        `âœ… Boa! VocÃª jÃ¡ palpitou na rodada ${desafio.rodadaAtual}. Agora Ã© orar, fera.`
      );
      return;
    }

    if (usuario.pendencia && usuario.pendencia.rodada) {
      mostrarMensagem(
        `ğŸŸ¢ VocÃª estÃ¡ vivo! Mas se liga que ainda tem jogo adiado da Rodada ${usuario.pendencia.rodada}. Bora palpitar a prÃ³xima rodada!`
      );
      return;
    }

    if (desafio.status === "iniciando") {
      mostrarMensagem(
        "ğŸ”¥ Chega mais! O desafio jÃ¡ vai comeÃ§ar. Ã‰ hora de palpitar."
      );
    } else {
      mostrarMensagem(
        `âš½ Ufa, vocÃª sobreviveu Ã  rodada ${desafio.rodadaAtual - 1}. Bora pra prÃ³xima. Hora de palpitar a rodada ${desafio.rodadaAtual}.`
      );
    }

    
  }
}


  // fallback de seguranÃ§a
  mostrarMensagem("âš ï¸ Estado do desafio desconhecido.");
}

function getAuthHeaders() {
  const token = localStorage.getItem("authToken");
  const challengeId = localStorage.getItem("challengeIdSelecionado");

  const headers = {
    "Authorization": `Bearer ${token}`
  };

  if (challengeId) {
    headers["X-CHALLENGE-ID"] = challengeId;
  }

  return headers;
}

async function carregarEstatisticasIndex() {
  const cardsContainer = document.querySelector(".index-cards");

  try {
    const token = localStorage.getItem("authToken");

    const res = await fetch("/api/index/estatisticas", {
      headers: 
        getAuthHeaders()
      }
    );

    if (!res.ok) throw new Error("Erro ao buscar estatÃ­sticas");

    const data = await res.json();

    // ğŸ”’ REGRA DE NEGÃ“CIO:
    // ainda estamos na rodada inicial?
    if (data.desafio.rodadaAtual === data.desafio.rodadaInicial) {
      // ğŸ‘‰ NÃƒO existe rodada encerrada
      cardsContainer.style.display = "none";
      return; // â›” para aqui, nÃ£o preenche nada
    }

    // âœ… jÃ¡ existe rodada encerrada
    cardsContainer.style.display = "flex";

    // ===== CARD 1 â€” DESAFIO =====
    document.getElementById("statIniciaram").textContent =
      data.jogadores.iniciaram;

    document.getElementById("statVivos").textContent =
      data.jogadores.vivos;

      // ===== PENDENTES (novo) =====
const pendBox = document.getElementById("statPendentesBox");
const pendSpan = document.getElementById("statPendentes");

if (data.jogadores.pendentes && data.jogadores.pendentes > 0) {
  pendBox.style.display = "inline-block";
  pendSpan.textContent = data.jogadores.pendentes;
} else {
  pendBox.style.display = "none";
}


    document.getElementById("statEliminados").textContent =
      data.jogadores.eliminados;

    document.getElementById("statPercentual").textContent =
      data.jogadores.percentualVivos;

    // ===== CARD 2 â€” RODADA =====
    document.getElementById("statRodadaTitulo").textContent =
      `Rodada ${data.desafio.rodadaResumo} â€” resumo`;

    document.getElementById("statEliminadosRodada").textContent =
      data.rodada.eliminados;

    const ul = document.getElementById("statTopTimes");
    ul.innerHTML = "";

    data.rodada.topTimes.forEach(t => {
      const li = document.createElement("li");
      li.textContent = `${t._id} â€” ${t.total} palpites`;
      ul.appendChild(li);
    });

    document.getElementById("statTimeMortal").textContent =
      data.rodada.timeMortal;

  } catch (err) {
    console.error(err);
  }
}



function mostrarMensagem(texto) {
  const box = document.getElementById("statusJogador");
  if (!box) return;

  box.style.display = "block";
  box.textContent = texto;

  // reset visual
  box.style.background = "linear-gradient(180deg, #EEF2FF, #FFFFFF)";
  box.style.color = "#1E3A8A";
  box.style.borderColor = "#E0E7FF";

  // estados visuais por contexto
  if (texto.includes("eliminado")) {
    box.style.background = "linear-gradient(180deg, #FEE2E2, #FFFFFF)";
    box.style.color = "#7F1D1D";
    box.style.borderColor = "#FCA5A5";
  }

  if (texto.includes("campeÃ£o")) {
    box.style.background = "linear-gradient(180deg, #ECFDF5, #FFFFFF)";
    box.style.color = "#065F46";
    box.style.borderColor = "#6EE7B7";
  }
}

document.addEventListener("DOMContentLoaded", async () => {

  const contexto = await carregarContextoDoJogoCompleto();
  if (!contexto) return;

  // ğŸ‘‰ Agora sim temos usuario + desafio
  interpretarContextoIndex(contexto);

  await carregarLinhaDoTempo();

  const status = contexto.desafio.status;

  if (["ativo", "aguardando", "finalizado"].includes(status)) {
    await carregarEstatisticasIndex();
  }
});



document.addEventListener("desafioAlterado", async () => {
  console.log("ğŸ”„ Desafio alterado â€” recarregando linha do tempo");
  await carregarLinhaDoTempo();
});

const btnMenuUser = document.getElementById("btnMenuUser");
const menuDropdown = document.getElementById("menuDropdown");
const btnLogout = document.getElementById("btnLogout");

btnMenuUser.addEventListener("click", (e) => {
  e.stopPropagation();
  menuDropdown.classList.toggle("hidden");
});

// fecha clicando fora
document.addEventListener("click", () => {
  menuDropdown.classList.add("hidden");
});

// logout real
btnLogout.addEventListener("click", () => {
  localStorage.removeItem("authToken");
  localStorage.removeItem("challengeIdSelecionado");

  window.location.href = "/login.html";
});

</script>

<div class="modal-confirmacao" id="modalComoJogar">
  <div class="modal-box" style="max-width: 520px; text-align:left;">
    <h3>ğŸ¯ Como funciona o Desafio Invictos</h3>

    <p>
      O Desafio Invictos Ã© um jogo de sobrevivÃªncia baseado no BrasileirÃ£o.
      Cada rodada vocÃª escolhe <strong>um time para vencer</strong>.
    </p>

    <ul style="padding-left:18px; font-size:14px; line-height:1.5;">
      <li>âš½ VocÃª escolhe 1 time por rodada</li>
      <li>âŒ Se o time perder, vocÃª Ã© eliminado</li>
      <li>ğŸ” NÃ£o pode repetir o mesmo time</li>
      <li>âš ï¸ O mesmo adversÃ¡rio sÃ³ pode ser enfrentado 3 vezes</li>
      <li>ğŸ† O Ãºltimo jogador vivo vence o desafio</li>
    </ul>

    <hr style="margin:16px 0; border:none; border-top:1px solid #E5E7EB;">

    <p><strong>ğŸ“ PÃ¡ginas principais:</strong></p>
    <ul style="padding-left:18px; font-size:14px;">
      <li><strong>InÃ­cio</strong> â†’ Acompanhe sua trajetÃ³ria</li>
      <li><strong>Palpitar</strong> â†’ Escolha seu time da rodada</li>
      <li><strong>Simulador</strong> â†’ Teste cenÃ¡rios futuros</li>
    </ul>

    <div class="acoes" style="margin-top:20px;">
      <button class="toast-btn fechar" onclick="fecharComoJogar()">Entendi</button>
    </div>
  </div>
</div>

<script>
const modalComoJogar = document.getElementById("modalComoJogar");
const btnComoJogar = document.getElementById("btnComoJogar");

btnComoJogar.addEventListener("click", () => {
  modalComoJogar.classList.add("ativo");
});

function fecharComoJogar() {
  modalComoJogar.classList.remove("ativo");
}
</script>


</body>
</html>