<!DOCTYPE html>
<html lang="pt-br">
<head>
 
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Palpitar</title>
   <link rel="preconnect" href="https://fonts.googleapis.com">
<link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="style.css">
  
</head>


<body class="page-palpitar">
<script src="authGuard.js"></script>


<div class="topo-palpitar">
<header>
  <div class="nav-bar">

    <div class="nav-left"></div>

    <ul class="nav-center">
      <li><a href="index.html" id="linkInicio">In√≠cio</a></li>
      <li><a href="palpitar.html" id="linkPalpitar">Palpitar!</a></li>
      <li><a href="simulador.html" id="linkSimulador">Simulador</a></li>
    </ul>

    <div class="user-menu">
      <button class="menu-btn" id="btnMenu">‚ò∞</button>

      <div class="menu-dropdown hidden" id="menuDropdown">
        <button id="btnLogout">üö™ Sair</button>
      </div>
    </div>

  </div>
</header>


<!-- ‚úÖ SELETOR DE DESAFIO (ESTAVA FALTANDO) -->
  <div id="seletorDesafioContainer" style="display:none;">
    <div>
      <strong>üéØ Desafio:</strong>
      <select id="selectDesafioGlobal"></select>
    </div>
  </div>
<script src="/js/seletorDesafio.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", initSeletorDesafio);
</script>
</div>
<script src="/js/alertaVerificacao.js"></script>


<div id="videoModal" class="modal">
  <div class="modal-content">
    <p id="avisoVideo" style="color: white; font-size: 18px; margin-bottom: 10px;">
      ‚è≥ Aguarde at√© o final do v√≠deo para que seu palpite seja registrado
    </p>
    <video
  id="videoPalpite"
  playsinline
  disablepictureinpicture
  controlslist="nodownload noplaybackrate nofullscreen noremoteplayback"
>
      <source src="palpite.mp4" type="video/mp4">
      Seu navegador n√£o suporta v√≠deos HTML5.
    </video>
  </div>
</div>

<script>
  const video = document.getElementById("videoPalpite");

  // üîí Bloqueia pause
  video.addEventListener("pause", () => {
    if (!video.ended) {
      video.play();
    }
  });

  // üîí Bloqueia clique no v√≠deo
  video.addEventListener("click", e => e.preventDefault());

  // üîí Bloqueia teclado enquanto modal est√° aberto
  document.addEventListener("keydown", e => {
    const modal = document.getElementById("videoModal");
    if (modal.classList.contains("ativo")) {
      e.preventDefault();
      e.stopPropagation();
    }
  });

  // üîí Bloqueia volume
  video.volume = 1;
  video.muted = false;
  video.addEventListener("volumechange", () => {
    video.volume = 1;
    video.muted = false;
  });

  // üîí Bloqueia fullscreen
  video.addEventListener("fullscreenchange", e => e.preventDefault());
</script>


<div class="container" style="position: relative;">

    <div id="bloqueioEliminado">
    <div class="overlay-box">
      <h2>‚ùå Voc√™ foi eliminado</h2>
      <p id="mensagemEliminacao"></p>
    </div>
  </div>

  <p class="mensagem-intro">Hora de palpitar. Qual time <strong>n√£o vai perder</strong> nessa rodada?</p>
  <h2 class="titulo-rodada">Rodada</h2>
  <p id="contador" style="font-size:18px; color:red; margin-bottom:15px;"></p>
  <div id="jogosContainer"></div>
  <button id="btnConfirmar" disabled>Confirmar Palpite</button>
</div>

<script>
  const paginaAtual = window.location.pathname.split("/").pop();
  if (paginaAtual.includes("index")) document.getElementById("linkInicio").classList.add("ativo");
  else if (paginaAtual.includes("palpitar")) document.getElementById("linkPalpitar").classList.add("ativo");
  else if (paginaAtual.includes("simulador")) document.getElementById("linkSimulador").classList.add("ativo");
  
  async function carregarContextoDoJogo() {
  const token = localStorage.getItem("authToken");

  if (!token) {
    return null;
  }

  const res = await fetch("/api/jogo/contexto", {
  headers: getAuthHeaders()
  });

  if (!res.ok) {
    throw new Error("Erro ao carregar contexto do jogo");
  }

  const data = await res.json();
  return data.desafio;
}

  let desafioAtual = null;

  
  let rodadaFixa = null; // vai vir do backend
  let jogosRodada = [];
  let jogosTodos = []; // <<< novo: guarda todos os jogos retornados por /api/jogos
  let timeSelecionado = null;
  let palpiteOriginal = null;

  const timesSelecionadosPorRodada = {};
  const contadorAdversarios = {};

   let deadline = null;
  let intervaloContagem = null;


  async function buscarJogos() {
  const resp = await fetch("/api/jogos");
  const data = await resp.json();

  // salvar todos os jogos para consultas posteriores (importante)
  jogosTodos = data.response || [];

  // filtrar apenas os jogos da rodada atual (rodadaFixa j√° deveria estar setada)
  jogosRodada = jogosTodos.filter(j => {
    const roundPart = (j.league && j.league.round) ? j.league.round.split(" - ")[1] : null;
    return parseInt(roundPart, 10) === rodadaFixa;
  });

  if (jogosRodada.length) {
    jogosRodada.sort((a,b)=> new Date(a.fixture.date)-new Date(b.fixture.date));
    deadline = new Date(jogosRodada[0].fixture.date);
    iniciarContagemRegressiva();
  } else {
    deadline = null;
    clearInterval(intervaloContagem);
    document.getElementById("contador").textContent = "";
  }

  await carregarPalpitesAnteriores();
  exibirRodada();
}


 async function carregarPalpitesAnteriores() {
  try {
    const token = localStorage.getItem("authToken");

const resp = await fetch("/api/palpites", {
headers: getAuthHeaders()
});
    if (!resp.ok) throw new Error("Erro ao buscar palpites");
    const palpites = await resp.json();

    // popula o mapa de palpites por rodada
    Object.keys(timesSelecionadosPorRodada).forEach(k => delete timesSelecionadosPorRodada[k]);
    palpites.forEach(p => timesSelecionadosPorRodada[p.rodada] = p.time);

    // Recalcular advers√°rios olhando todos os jogos (jogosTodos)
    Object.keys(contadorAdversarios).forEach(k => delete contadorAdversarios[k]);

    for (const rodadaStr in timesSelecionadosPorRodada) {
      const rodadaNum = Number(rodadaStr);
      const timeEscolhido = timesSelecionadosPorRodada[rodadaStr];

      // procurar o jogo dessa rodada onde esse time participou, dentro de todos os jogos
      const jogoEncontrado = jogosTodos.find(j => {
        if (!j.league || !j.league.round) return false;
        const part = j.league.round.split(" - ")[1];
        return Number(part) === rodadaNum && (j.teams.home.name === timeEscolhido || j.teams.away.name === timeEscolhido);
      });

      if (!jogoEncontrado) continue;

      const adversario = jogoEncontrado.teams.home.name === timeEscolhido
        ? jogoEncontrado.teams.away.name
        : jogoEncontrado.teams.home.name;

      contadorAdversarios[adversario] = (contadorAdversarios[adversario] || 0) + 1;
    }

    // Se j√° houver um palpite salvo para a rodada atual, marque-o como timeSelecionado
    timeSelecionado = timesSelecionadosPorRodada[rodadaFixa] || null;
 // palpite salvo na rodada atual
palpiteOriginal = timesSelecionadosPorRodada[rodadaFixa] || null;

// sele√ß√£o atual come√ßa igual ao original
timeSelecionado = palpiteOriginal;

atualizarEstadoBotao();

  } catch(e){
    console.error(e);
  }
}

async function verificarStatusJogador() {
  try {
    const token = localStorage.getItem("authToken");
    if (!token) return;

    const res = await fetch("/api/status-jogador", {
      headers: getAuthHeaders()
    });

    const data = await res.json();

if (data.status === "eliminado" && data.rodadaEliminacao !== null) {
  const overlay = document.getElementById("bloqueioEliminado");
  overlay.style.display = "flex";

  document.getElementById("mensagemEliminacao").textContent =
    `Voc√™ foi eliminado na rodada ${data.rodadaEliminacao}.`;

  document.getElementById("btnConfirmar").disabled = true;
    }

  } catch (err) {
    console.error("Erro ao verificar status do jogador", err);
  }
}

  function iniciarContagemRegressiva() {
    const c = document.getElementById("contador");
    intervaloContagem = setInterval(()=>{
      const diff = deadline - new Date();
     const h=Math.floor(diff/(1000*60*60)), m=Math.floor((diff%(1000*60*60))/(1000*60)), s=Math.floor((diff%(1000*60))/1000);
      c.textContent=`‚è≥ Tempo restante: ${h}h ${m}m ${s}s`;
    },1000);
  }

 function exibirRodada(){
  const container = document.getElementById("jogosContainer");
  container.innerHTML="";
  if(!jogosRodada.length){ container.innerHTML="<p>Sem jogos nesta rodada.</p>"; return; }

  // times j√° usados em outras rodadas (n√£o contar a rodada atual)
  const timesJaUsados = Object.entries(timesSelecionadosPorRodada)
    .filter(([r])=>parseInt(r)!==rodadaFixa).map(([,t])=>t);

  // advers√°rios bloqueados em fun√ß√£o do contador global
  const advBloqueados = Object.keys(contadorAdversarios).filter(t=>contadorAdversarios[t]>=3);

  jogosRodada.forEach(j=>{
    const div=document.createElement("div"); div.className="jogo";
    const dh = new Date(j.fixture.date);
    const data = dh.toLocaleDateString('pt-BR'), hora=dh.toLocaleTimeString('pt-BR',{hour:'2-digit',minute:'2-digit'});
    const h=j.teams.home.name, a=j.teams.away.name;

    // agora avaliamos desativa√ß√£o consultando timesJaUsados E advBloqueados
    let motivoHome = "";
let motivoAway = "";

if (timesJaUsados.includes(h)) {
  motivoHome = "‚ö†Ô∏è Time j√° escolhido em outra rodada";
} else if (advBloqueados.includes(a)) {
  motivoHome = "üö´ Voc√™ j√° enfrentou esse advers√°rio 3 vezes";
}

if (timesJaUsados.includes(a)) {
  motivoAway = "‚ö†Ô∏è Time j√° escolhido em outra rodada";
} else if (advBloqueados.includes(h)) {
  motivoAway = "üö´ Voc√™ j√° enfrentou esse advers√°rio 3 vezes";
}

const isHomeDesativ =
  timesJaUsados.includes(h) || advBloqueados.includes(a);

const isAwayDesativ =
  timesJaUsados.includes(a) || advBloqueados.includes(h);

    // construir classes incluindo "selecionado" se for o timeSelecionado
    const homeClasses = ["time"];
    if (timeSelecionado===h) homeClasses.push("selecionado");
    if (isHomeDesativ) homeClasses.push("desativado");

    const awayClasses = ["time"];
    if (timeSelecionado===a) awayClasses.push("selecionado");
    if (isAwayDesativ) awayClasses.push("desativado");

div.innerHTML = `
  <div class="data-hora">${data} - ${hora}</div>

  <div class="linha-confronto">

    <div class="time-wrapper">
      <div
        class="${homeClasses.join(" ")}"
  data-motivo="${motivoHome}"
  ${isHomeDesativ ? "" : `onclick="selecionarTime('${h}')"`}>
        ${h}
      </div>
      <a href="#" class="odd" target="_blank" onclick="event.stopPropagation()">1.85</a>
    </div>

    <div class="vs">VS</div>

    <div class="time-wrapper">
      <div
        class="${awayClasses.join(" ")}"
  data-motivo="${motivoAway}"
  ${isAwayDesativ ? "" : `onclick="selecionarTime('${a}')"`}>
        ${a}
      </div>
      <a href="#" class="odd" target="_blank" onclick="event.stopPropagation()">1.85</a>
    </div>

  </div>

  <div class="local">${j.fixture.venue.name}</div>
`;

    container.appendChild(div);
  });
  }


function selecionarTime(time){
  timeSelecionado = (timeSelecionado===time)? null: time;

  if (timeSelecionado) {
    timesSelecionadosPorRodada[rodadaFixa] = timeSelecionado;
  } else {
    delete timesSelecionadosPorRodada[rodadaFixa];
  }

  // Opcional: recalcular contadorAdversarios localmente para refletir sele√ß√£o imediata
  // (poderia chamar uma fun√ß√£o que reexecuta o loop de contador com jogosTodos)
  // Para simplicidade, vamos simplesmente recarregar a exibi√ß√£o:
  exibirRodada();
atualizarEstadoBotao();
}

function fecharModalVideo() {
  const modal = document.getElementById("videoModal");
  const video = document.getElementById("videoPalpite");

  video.pause();
  video.currentTime = 0;
  modal.classList.remove("ativo");
}

function atualizarEstadoBotao() {
  const btn = document.getElementById("btnConfirmar");

  if (!timeSelecionado) {
    btn.disabled = true;
    return;
  }

  btn.disabled = timeSelecionado === palpiteOriginal;
}


function esperarFimDoVideo(video) {
  return new Promise(resolve => {
    video.onended = () => {
      resolve();
    };
  });
}

  document.getElementById("btnConfirmar").addEventListener("click", async () => {
  if (!timeSelecionado) return;

  const modal = document.getElementById("videoModal");
  const video = document.getElementById("videoPalpite");
  const aviso = document.getElementById("avisoVideo");

  // 1Ô∏è‚É£ Abre modal e toca v√≠deo
  modal.classList.add("ativo");
  aviso.style.display = "block";
  video.currentTime = 0;
  video.play();

  // 2Ô∏è‚É£ ESPERA o v√≠deo terminar
  await esperarFimDoVideo(video);

  // 3Ô∏è‚É£ Agora sim: envia o palpite
  try {
    const token = localStorage.getItem("authToken");

    if (!token) {
      alert("Voc√™ precisa estar logado para palpitar.");
      fecharModalVideo();
      window.location.href = "/login.html";
      return;
    }

const res = await fetch("/api/palpite", {
  method: "POST",
  headers: {
    ...getAuthHeaders(),
    "Content-Type": "application/json"
  },
  body: JSON.stringify({
    rodada: rodadaFixa,
    time: timeSelecionado
  })
});


    const data = await res.json();

 if (!res.ok && data.codigo === "EMAIL_NAO_VERIFICADO") {

  mostrarToast(
    "‚ö†Ô∏è Verifique seu e-mail para conseguir palpitar.",
    "erro",
    `
      <button class="toast-btn" id="btnReenviarToast">üì© Reenviar link</button>
      <button class="toast-btn fechar" id="btnFecharToast">Fechar</button>
    `
  );

  // ‚ö†Ô∏è esperar DOM do toast existir
  setTimeout(() => {
    const btnReenviar = document.getElementById("btnReenviarToast");
    const btnFechar = document.getElementById("btnFecharToast");

    if (btnReenviar) {
  btnReenviar.onclick = async () => {
  btnReenviar.disabled = true;
  btnReenviar.textContent = "Enviando...";

  await fetch("/api/reenviar-verificacao", {
    method: "POST",
    headers: getAuthHeaders()
  });

        mostrarToast("‚úÖ Link reenviado! Verifique seu e-mail.", "sucesso");
      };
    }

    if (btnFechar) {
      btnFechar.onclick = () => {
        document.getElementById("toast").classList.remove("ativo");
      };
    }
  }, 50);

  fecharModalVideo();
  return;
}


if (res.ok) {
  mostrarToast(`‚úÖ ${data.message}`, "sucesso");

  // üîí AJUSTE 4 ‚Äî trava novamente ap√≥s salvar
  palpiteOriginal = timeSelecionado;
  atualizarEstadoBotao();

  fecharModalVideo();
} else {
  mostrarToast(`‚ùå ${data.message || "Erro ao salvar palpite"}`, "erro");
  fecharModalVideo();
}

  } catch (e) {
    mostrarToast("‚ùå Erro de conex√£o com o servidor", "erro");
    fecharModalVideo();
  }
});
;

function getAuthHeaders() {
  const token = localStorage.getItem("authToken");
  const challengeId = localStorage.getItem("challengeIdSelecionado");

  const headers = {
    "Authorization": `Bearer ${token}`
  };

  if (challengeId) {
    headers["X-CHALLENGE-ID"] = challengeId;
  }

  return headers;
}

function aplicarEstadoDoDesafio(desafio) {
  const contador = document.getElementById("contador");
  const container = document.getElementById("jogosContainer");
  const btn = document.getElementById("btnConfirmar");


  // ‚ùå usu√°rio nao inscrito + desafio j√° andando
// ‚ùå usu√°rio nao inscrito + desafio j√° andando
if (
  desafio.usuario?.status === "nao_inscrito" &&
  desafio.status !== "iniciando"
) {

  const overlay = document.getElementById("bloqueioEliminado");
  const msg = document.getElementById("mensagemEliminacao");

  overlay.style.display = "flex";

  msg.textContent =
    "‚õî Voc√™ n√£o entrou no desafio a tempo. " +
    "Aguarde o pr√≥ximo para participar.";

  return false;
}
  // üëâ Se o overlay de eliminado estiver vis√≠vel, N√ÉO sobrescreve nada
  const overlay = document.getElementById("bloqueioEliminado");
  if (overlay.style.display === "flex") {
    return false;
  }

  container.innerHTML = "";
  btn.disabled = true;
  contador.textContent = "";

  if (desafio.status === "aguardando") {
    contador.textContent =
      "‚è≥ Agora j√° foi. Acompanhe a rodada e aproveite para fazer simula√ß√µes.";
    return false;
  }

  if (desafio.status === "finalizado") {
    contador.textContent =
      "üèÅ Desafio finalizado. Obrigado por participar!";
    return false;
  }

  return true;
}


function mostrarToast(mensagem, tipo = "sucesso", actionsHTML = "") {
  const toast = document.getElementById("toast");
  const msg = document.getElementById("toastMsg");
  const actions = document.getElementById("toastActions");
  const overlay = document.getElementById("toastOverlay"); // üëà ADICIONADO

  msg.textContent = mensagem;
  actions.innerHTML = actionsHTML;

  toast.className = `toast ativo ${tipo}`;

  overlay?.classList.add("ativo"); // üëà ADICIONADO

  if (tipo === "sucesso") {
    actions.innerHTML += `
      <button class="toast-btn fechar" id="toastFecharAuto">Fechar</button>
    `;
  }

  setTimeout(() => {
    const btn = document.getElementById("toastFecharAuto");
    if (btn) btn.onclick = () => {
      toast.classList.remove("ativo");
      overlay?.classList.remove("ativo"); // üëà ADICIONADO
    };
  }, 10);

  requestAnimationFrame(() => {});
}


async function initPalpitar() {
  desafioAtual = await carregarContextoDoJogo();

  if (!desafioAtual) {
    alert("Nenhum desafio ativo no momento.");
    return;
  }

  // üîë SEMPRE define a rodada visual
rodadaFixa = desafioAtual.rodadaAtual;

const titulo = document.querySelector(".titulo-rodada");
if (titulo) {
  titulo.textContent = `Rodada ${rodadaFixa}`;
}

// 1¬∫ ‚Äî verifica se o JOGADOR est√° eliminado (prioridade total)
await verificarStatusJogador();

// 2¬∫ ‚Äî s√≥ depois aplica regras do DESAFIO
const podeContinuar = aplicarEstadoDoDesafio(desafioAtual);
if (!podeContinuar) return;

await buscarJogos();
}

initPalpitar();

document.addEventListener("desafioAlterado", async () => {
  console.log("üîÑ Desafio alterado ‚Äî reiniciando Palpitar");

  // üî• LIMPA ESTADO ANTIGO
  rodadaFixa = null;
  jogosRodada = [];
  jogosTodos = [];
  timeSelecionado = null;

  Object.keys(timesSelecionadosPorRodada).forEach(k => delete timesSelecionadosPorRodada[k]);
  Object.keys(contadorAdversarios).forEach(k => delete contadorAdversarios[k]);

  clearInterval(intervaloContagem);
  document.getElementById("contador").textContent = "";
  document.getElementById("jogosContainer").innerHTML = "";

  // üîë RECARREGA CONTEXTO DO NOVO DESAFIO
  await initPalpitar();
});


const btnMenuUser = document.getElementById("btnMenu");
const menuDropdown = document.getElementById("menuDropdown");
const btnLogout = document.getElementById("btnLogout");

if (btnMenuUser && menuDropdown) {
  btnMenuUser.addEventListener("click", (e) => {
    e.stopPropagation();
    menuDropdown.classList.toggle("hidden");
  });

  document.addEventListener("click", () => {
    menuDropdown.classList.add("hidden");
  });

  menuDropdown.addEventListener("click", (e) => {
    e.stopPropagation();
  });
}

if (btnLogout) {
  btnLogout.addEventListener("click", () => {
    localStorage.removeItem("authToken");
    localStorage.removeItem("challengeIdSelecionado");
    window.location.href = "/login.html";
  });
}
</script>

<div id="toast" class="toast">
  <span id="toastMsg"></span>
  <div id="toastActions"></div>
</div>
<div id="toastOverlay"></div>
</body>
</html>